#!/usr/bin/env ansible-playbook
- name: setup logins and secure sshd
  hosts: wurzelMasters wurzelNodes
  remote_user: pi
  gather_facts: no
  vars:
    username: wuerzelchen
    user_groups: [ sudo ]
  tasks:
    - name: check connectivity
      ping:
    - name: enable ssh on startup
      systemd:
        state: started
        enabled: yes
        name: ssh
    - name: update root passwd from vault
      become: yes
      user:
        name: root
        password: "{{ root_password }}"
    - name: adding {{ username }} with passwd from vault
      become: true
      user:
        name: "{{ username }}"
        shell: /bin/bash
        groups: "{{ user_groups }}"
        append: yes
        password: "{{ user_password }}"
    - name: adding authorized_key for {{ username }}
      become: true
      authorized_key:
        user: "{{ username }}"
        state: present
        key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"
